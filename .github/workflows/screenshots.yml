name: GoDiffy Visual Regression

on:
  push:
    branches-ignore:
      - 'main'
      - 'master'
  pull_request:

jobs:
  upload-screenshots:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Capture and upload screenshots
      uses: MichaelFisher1997/godiffy-github-actions@dev
      with:
        api-key: ${{ secrets.GODIFFY_API_KEY }}
        site-id: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
        capture-screenshots: true
        config-path: './godiffy.json'
        base-url: https://godiffy-backend-dev.up.railway.app
        create-report: false

  compare-screenshots:
    if: github.event_name == 'pull_request'
    needs: upload-screenshots
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Wait for backend to process uploads
      run: sleep 5

    - name: Run visual regression comparison
      id: compare
      uses: MichaelFisher1997/godiffy-github-actions@dev
      with:
        api-key: ${{ secrets.GODIFFY_API_KEY }}
        site-id: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
        capture-screenshots: false
        config-path: './godiffy.json'
        base-url: https://godiffy-backend-dev.up.railway.app
        baseline-branch: ${{ github.base_ref }}
        baseline-commit: latest
        create-report: true

    - name: Comment on PR with results
      if: always() && steps.compare.outputs['report-url'] != ''
      uses: actions/github-script@v7
      with:
        script: |
          const passed = '${{ steps.compare.outputs['passed-comparisons'] }}';
          const total = '${{ steps.compare.outputs['total-comparisons'] }}';
          const avgSim = '${{ steps.compare.outputs['average-similarity'] }}';
          const reportUrl = '${{ steps.compare.outputs['report-url'] }}';
          const thresholdMet = '${{ steps.compare.outputs['threshold-met'] }}' === 'true';
          const failed = total - passed;
          
          const status = thresholdMet ? 'âœ… PASSED' : 'âŒ FAILED';
          const icon = thresholdMet ? 'âœ…' : 'âŒ';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ${icon} Visual Regression Report - ${status}
            
            **Results:** ${passed}/${total} comparisons passed
            **Average Similarity:** ${avgSim}%
            **Threshold:** 95%
            
            ${!thresholdMet ? 'âš ï¸ **Visual changes detected that exceed the acceptable threshold**' : 'âœ… All visual changes are within acceptable limits'}
            ${failed > 0 ? '\nâš ï¸ ' + failed + ' comparison(s) below individual threshold' : ''}
            
            **ğŸ”— [View Full Report](${reportUrl})**
            
            ---
            *Generated by GoDiffy GitHub Action*`
          })