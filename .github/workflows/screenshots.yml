name: GoDiffy Visual Regression

on:
  push:
  pull_request:

jobs:
  upload-screenshots:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Capture and upload screenshots
      uses: MichaelFisher1997/godiffy-github-actions@dev
      with:
        api-key: ${{ secrets.GODIFFY_API_KEY }}
        site-id: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
        capture-screenshots: true
        config-path: './godiffy.json'
        base-url: https://godiffy-backend-dev.up.railway.app
        create-report: false

  compare-screenshots:
    if: github.event_name == 'pull_request' || github.ref != 'refs/heads/master'
    needs: upload-screenshots
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Wait for backend to process uploads
      run: sleep 5

    - name: Run visual regression comparison
      id: compare
      continue-on-error: true
      uses: MichaelFisher1997/godiffy-github-actions@dev
      with:
        api-key: ${{ secrets.GODIFFY_API_KEY }}
        site-id: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
        capture-screenshots: false
        config-path: './godiffy.json'
        base-url: https://godiffy-backend-dev.up.railway.app
        baseline-branch: ${{ github.base_ref }}
        baseline-commit: latest
        create-report: true

    - name: Comment on PR with results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const passed = '${{ steps.compare.outputs['passed-comparisons'] }}';
          const total = '${{ steps.compare.outputs['total-comparisons'] }}';
          const avgSim = '${{ steps.compare.outputs['average-similarity'] }}';
          const reportUrl = '${{ steps.compare.outputs['report-url'] }}';
          const thresholdMet = '${{ steps.compare.outputs['threshold-met'] }}' === 'true';
          
          // Skip if no comparison data
          if (!total || !reportUrl) {
            console.log('No comparison results available, skipping comment');
            return;
          }
          
          const failed = total - passed;
          const status = thresholdMet ? '‚úÖ PASSED' : '‚ùå FAILED';
          const icon = thresholdMet ? '‚úÖ' : '‚ùå';
          
          // Find PR number for push events
          let prNumber = context.issue.number;
          if (!prNumber && context.eventName === 'push') {
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`
            });
            if (prs.data.length > 0) {
              prNumber = prs.data[0].number;
            }
          }
          
          if (!prNumber) {
            console.log('No PR found, skipping comment');
            return;
          }
          
          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ${icon} Visual Regression Report - ${status}
            
            **Results:** ${passed}/${total} comparisons passed
            **Average Similarity:** ${avgSim}%
            **Threshold:** 95%
            
            ${!thresholdMet ? '‚ö†Ô∏è **Visual changes detected that exceed the acceptable threshold**' : '‚úÖ All visual changes are within acceptable limits'}
            ${failed > 0 ? '\n‚ö†Ô∏è ' + failed + ' comparison(s) below individual threshold' : ''}
            
            **üîó [View Full Report](${reportUrl})**
            
            ---
            *Generated by GoDiffy GitHub Action*`
          })
    
    - name: Fail if threshold not met
      if: steps.compare.outputs['threshold-met'] == 'false'
      run: |
        echo "::error::Visual regression check failed - similarity below threshold"
        exit 1