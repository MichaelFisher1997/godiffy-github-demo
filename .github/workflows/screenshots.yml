name: GoDiffy Visual Regression

on:
  push:
  pull_request:

jobs:
  visual-regression:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Upload screenshots to GoDiffy
      id: upload
      uses: MichaelFisher1997/godiffy-github-actions@dev
      with:
        api-key: ${{ secrets.GODIFFY_API_KEY }}
        site-id: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
        capture-screenshots: true
        config-path: './godiffy.json'
        base-url: https://godiffy-backend-dev.up.railway.app
        create-report: false

    - name: Run visual regression comparison
      id: compare
      if: github.event_name == 'pull_request' && success()
      uses: MichaelFisher1997/godiffy-github-actions@dev
      with:
        api-key: ${{ secrets.GODIFFY_API_KEY }}
        site-id: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
        base-url: https://godiffy-backend-dev.up.railway.app
        baseline-branch: ${{ github.base_ref }}
        baseline-commit: latest
        create-report: true
        algorithm: pixelmatch
        threshold: 0.9

    - name: Comment on PR with results
      if: github.event_name == 'pull_request' && steps.compare.outputs['report-url'] != ''
      uses: actions/github-script@v7
      with:
        script: |
          const passed = '${{ steps.compare.outputs['passed-comparisons'] }}';
          const total = '${{ steps.compare.outputs['total-comparisons'] }}';
          const avgSim = '${{ steps.compare.outputs['average-similarity'] }}';
          const reportUrl = '${{ steps.compare.outputs['report-url'] }}';
          const failed = total - passed;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ“Š Visual Regression Report
            
            **Results:** ${passed}/${total} comparisons passed (${avgSim}% average similarity)
            ${failed > 0 ? 'âš ï¸ ' + failed + ' visual change(s) detected' : 'âœ… All comparisons passed'}
            ${reportUrl ? '\n**ğŸ”— [View Full Report](' + reportUrl + ')**' : ''}
            
            ---
            *Generated by GoDiffy GitHub Action*`
          })