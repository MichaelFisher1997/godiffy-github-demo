name: GoDiffy Visual Regression

on:
  push:
  pull_request:

jobs:
  upload-screenshots:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Capture and upload screenshots
      uses: MichaelFisher1997/godiffy-github-actions@dev
      with:
        api-key: ${{ secrets.GODIFFY_API_KEY }}
        site-id: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
        capture-screenshots: true
        config-path: './godiffy.json'
        base-url: https://godiffy-backend-dev.up.railway.app
        create-report: false

  compare-screenshots:
    if: github.event_name == 'pull_request' || github.ref != 'refs/heads/master'
    needs: upload-screenshots
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Wait for backend to process uploads
      run: sleep 5

    - name: Run visual regression comparison
      id: compare
      continue-on-error: true
      uses: MichaelFisher1997/godiffy-github-actions@dev
      with:
        api-key: ${{ secrets.GODIFFY_API_KEY }}
        site-id: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
        capture-screenshots: false
        config-path: './godiffy.json'
        base-url: https://godiffy-backend-dev.up.railway.app
        baseline-branch: ${{ github.base_ref }}
        baseline-commit: latest
        create-report: true

    - name: Fetch report and comment on PR
      if: always()
      uses: actions/github-script@v7
      env:
        GODIFFY_API_KEY: ${{ secrets.GODIFFY_API_KEY }}
        GODIFFY_BASE_URL: https://godiffy-backend-dev.up.railway.app
        SITE_ID: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
      with:
        script: |
          const baseUrl = process.env.GODIFFY_BASE_URL;
          const apiKey = process.env.GODIFFY_API_KEY;
          const siteId = process.env.SITE_ID;
          const branch = context.ref.replace('refs/heads/', '');
          const commit = context.sha;
          
          // Find PR number for push events
          let prNumber = context.issue.number;
          if (!prNumber && context.eventName === 'push') {
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branch}`
            });
            if (prs.data.length > 0) {
              prNumber = prs.data[0].number;
            }
          }
          
          if (!prNumber) {
            console.log('No PR found, skipping comment');
            return;
          }
          
          // Fetch latest reports and find one for this commit
          const reportsUrl = `${baseUrl}/api/v2/sites/${siteId}/reports?limit=10`;
          const reportsRes = await fetch(reportsUrl, {
            headers: { 'Authorization': `Bearer ${apiKey}` }
          });
          
          if (!reportsRes.ok) {
            console.log('Failed to fetch reports:', reportsRes.status);
            return;
          }
          
          const data = await reportsRes.json();
          const reports = data.reports || [];
          
          // Find report for this commit
          const report = reports.find(r => r.candidateCommit === commit);
          
          if (!report) {
            console.log('No report found for commit:', commit);
            return;
          }
          const avgSim = (report.averageSimilarity * 100).toFixed(2);
          const threshold = 95; // Read from config if needed
          const thresholdMet = report.averageSimilarity >= (threshold / 100);
          const passed = report.passedComparisons || 0;
          const total = report.totalComparisons || 0;
          const failed = total - passed;
          
          const status = thresholdMet ? '‚úÖ PASSED' : '‚ùå FAILED';
          const icon = thresholdMet ? '‚úÖ' : '‚ùå';
          const reportUrl = `${baseUrl}/sites/${siteId}/reports/${report.id}`;
          
          const body = `## ${icon} Visual Regression Report - ${status}
          
          **Results:** ${passed}/${total} comparisons passed
          **Average Similarity:** ${avgSim}%
          **Threshold:** ${threshold}%
          
          ${!thresholdMet ? '‚ö†Ô∏è **Visual changes detected that exceed the acceptable threshold**' : '‚úÖ All visual changes are within acceptable limits'}
          ${failed > 0 ? `\n‚ö†Ô∏è ${failed} comparison(s) below individual threshold` : ''}
          
          **üîó [View Full Report](${reportUrl})**
          
          ---
          *Generated by GoDiffy GitHub Action*`;
          
          await github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
          
          // Fail the workflow if threshold not met
          if (!thresholdMet) {
            core.setFailed(`Visual regression check failed: ${avgSim}% similarity is below ${threshold}% threshold`);
          }