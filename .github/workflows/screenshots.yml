name: GoDiffy Visual Regression

on:
  push:
  pull_request:

jobs:
  upload-screenshots:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Capture and upload screenshots
      uses: MichaelFisher1997/godiffy-github-actions@dev
      with:
        api-key: ${{ secrets.GODIFFY_API_KEY }}
        site-id: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
        capture-screenshots: true
        config-path: './godiffy.json'
        base-url: https://godiffy-backend-dev.up.railway.app
        create-report: false

  compare-screenshots:
    if: github.event_name == 'pull_request' || github.ref != 'refs/heads/master'
    needs: upload-screenshots
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Wait for backend to process uploads
      run: sleep 5

    - name: Run visual regression comparison
      uses: MichaelFisher1997/godiffy-github-actions@dev
      with:
        api-key: ${{ secrets.GODIFFY_API_KEY }}
        site-id: 9b85b790-c00e-4cfa-aed8-848617a6dd8d
        capture-screenshots: false
        config-path: './godiffy.json'
        base-url: https://godiffy-backend-dev.up.railway.app
        baseline-branch: ${{ github.base_ref }}
        baseline-commit: latest
        create-report: true
        post-pr-comment: true
        github-token: ${{ secrets.GITHUB_TOKEN }}